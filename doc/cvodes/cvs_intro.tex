%===================================================================================
\chapter{Introduction}\label{s:intro}
%===================================================================================

{\cvodes}~\cite{SeHi:05} is part of a software family called {\sundials}: 
SUite of Nonlinear and DIfferential/ALgebraic equation Solvers~\cite{HBGLSSW:05}.  
This suite consists of {\cvode}, {\arkode}, {\kinsol} and {\ida}, and variants
of these with sensitivity analysis capabilities.
%
{\cvodes}\index{CVODES@{\cvodes}!brief description of} is a solver for
stiff and nonstiff initial value problems (IVPs) for systems of
ordinary differential equation (ODEs). In addition to solving stiff
and nonstiff ODE systems, {\cvodes} has sensitivity analysis
capabilities, using either the forward or the adjoint methods.

%---------------------------------
\section{Historical Background}\label{ss:history}
%---------------------------------

\index{CVODES@{\cvodes}!relationship to {\vode}, {\vodpk}|(}
{\F} solvers for ODE initial value problems are widespread and heavily used. 
Two solvers that have been written at LLNL in the past are {\vode}~\cite{BBH:89} 
and {\vodpk}~\cite{Byr:92}.
{\vode}\index{VODE@{\vode}} is a general purpose solver that includes methods for
both stiff and nonstiff systems, and in the stiff case uses direct methods (full or
banded) for the solution of the linear systems that arise at each implicit
step. Externally, {\vode} is very similar to the well known solver
{\lsode}\index{LSODE@{\lsode}}~\cite{RaHi:94}. {\vodpk}\index{VODPK@{\vodpk}}
is a variant of {\vode} that uses a preconditioned Krylov (iterative)
method, namely GMRES, for the solution of the linear systems. {\vodpk}
is a powerful tool for large stiff systems because it combines
established methods for stiff integration, nonlinear iteration, and
Krylov (linear) iteration with a problem-specific treatment of the
dominant source of stiffness, in the form of the user-supplied
preconditioner matrix~\cite{BrHi:89}.  The capabilities of both
{\vode} and {\vodpk} have been combined in the {\CC}-language package
{\cvode}\index{CVODE@{\cvode}}~\cite{CoHi:96}.

At present, {\cvode} may utilize a variety of Krylov methods provided
in {\sundials} that can be used in conjuction with Newton iteration:
these include the GMRES (Generalized Minimal RESidual)~\cite{SaSc:86},
FGMRES (Flexible Generalized Minimum RESidual)~\cite{Saa:93},
Bi-CGStab (Bi-Conjugate Gradient Stabilized)~\cite{Van:92}, TFQMR
(Transpose-Free Quasi-Minimal Residual)~\cite{Fre:93}, and PCG
(Preconditioned Conjugate Gradient)~\cite{HeSt:52} linear iterative
methods.  As Krylov methods, these require almost no  
matrix storage for solving the Newton equations as compared to direct 
methods. However, the algorithms allow for a user-supplied preconditioner
matrix, and for most problems preconditioning is essential for an
efficient solution.
For very large stiff ODE systems, the Krylov methods are preferable over
direct linear solver methods, and are often the only feasible choice.
Among the Krylov methods in {\sundials}, we recommend GMRES as the
best overall choice.  However, users are encouraged to compare all
options, especially if encountering convergence failures with GMRES.
Bi-CGStab and TFQMR have an advantage in storage requirements, in
that the number of workspace vectors they require is fixed, while that
number for GMRES depends on the desired Krylov subspace size.  FGMRES
has an advantage in that it is designed to support preconditioners
that vary between iterations (e.g.~iterative methods).  PCG exhibits
rapid convergence and minimal workspace vectors, but only works for
symmetric linear systems.

In the process of translating the {\vode} and {\vodpk} algorithms into
{\CC}, the overall {\cvode} organization has been changed considerably.
One key feature of the {\cvode} organization is that the linear system
solvers comprise a layer of code modules that is separated from the
integration algorithm, allowing for easy modification and expansion of
the linear solver array.  A second key feature is a separate module
devoted to vector operations; this facilitated the extension to
multiprosessor environments with minimal impacts on the rest of the
solver, resulting in {\pvode}\index{PVODE@{\pvode}}~\cite{ByHi:99},
the parallel variant of {\cvode}.  \index{CVODES@{\cvodes}!relationship
to {\vode}, {\vodpk}|)}

\index{CVODES@{\cvodes}!relationship to {\cvode}, {\pvode}|(}
{\cvodes} is written with a functionality that is a superset of that
of the pair {\cvode}/{\pvode}. Sensitivity analysis capabilities, both
forward and adjoint, have been added to the main integrator. Enabling
forward sensititivity computations in {\cvodes} will result in the
code integrating the so-called {\em sensitivity equations}
simultaneously with the original IVP, yielding both the solution and
its sensitivity with respect to parameters in the model. Adjoint
sensitivity analysis, most useful when the gradients of relatively few
functionals of the solution with respect to many parameters are
sought, involves integration of the original IVP forward in time
followed by the integration of the so-called {\em adjoint equations}
backward in time. {\cvodes} provides the infrastructure needed to
integrate any final-condition ODE dependent on the solution of the
original IVP (in particular the adjoint system).

Development of {\cvodes} was concurrent with a redesign of the vector
operations module across the {\sundials} suite. The key feature of the
{\nvector} module is that it is written in terms of abstract
vector operations with the actual vector functions attached by a
particular implementation (such as serial or parallel) of
{\nvector}. This allows writing the {\sundials} solvers in a manner
independent of the actual {\nvector} implementation (which can be
user-supplied), as well as allowing more than one {\nvector} module to
be linked into an executable file.
{\sundials} (and thus {\cvodes}) is supplied with serial, 
MPI-parallel, and both openMP and Pthreads thread-parallel
{\nvector} implementations.
\index{CVODES@{\cvodes}!relationship to {\cvode}, {\pvode}|)}

\index{CVODES@{\cvodes}!motivation for writing in C|(} There were
several motivations for choosing the {\CC} language for {\cvode}, and
later for {\cvodes}.  First, a general movement away from {\F} and
toward {\CC} in scientific computing was apparent.
Second, the pointer, structure, and dynamic memory allocation features
in {\CC} are extremely useful in software of this complexity.  Finally,
we prefer {\CC} over {\CPP} for {\cvodes} because of the wider
availability of {\CC} compilers, the potentially greater efficiency of
{\CC}, and the greater ease of interfacing the solver to applications
written in extended {\F}.  \index{CVODES@{\cvodes}!motivation for
writing in C|)}

\section{Changes from previous versions}

\subsection*{Changes in v3.2.0}

Support for optional inequality constraints on individual components of the
solution vector has been added to {\cvode} and {\cvodes}. See Chapter
\ref{s:math} and the description of \id{CVodeSetConstraints} in
\S\ref{sss:optin_main} for more details. Use of \id{CVodeSetConstraints}
requires the {\nvector} operations \id{N\_MinQuotient}, \id{N\_VConstrMask}, and
\id{N\_VCompare} that were not previously required by {\cvode} and {\cvodes}.
\\
\\
\noindent Fixed a thread-safety issue when using ajdoint sensitivity analysis.
\\
\\
\noindent Fixed a problem with setting \id{sunindextype} which would occur
with some compilers (e.g. armclang) that did not define \id{\_\_STDC\_VERSION\_\_}.
\\
\\
\noindent Added hybrid MPI/CUDA and MPI/RAJA vectors to allow use of more 
than one MPI rank when using a GPU system.  The vectors assume one GPU 
device per MPI rank.
\\
\\
\noindent Changed the name of the RAJA {\nvector} library to
\id{libsundials\_nveccudaraja.lib} from \newline
\id{libsundials\_nvecraja.lib} to better reflect that we only support CUDA
as a backend for RAJA currently.
\\
\\
\noindent Several changes were made to the build system:
\begin{itemize}
\item CMake 3.1.3 is now the minimum required CMake version.
\item Deprecate the behavior of the \id{SUNDIALS\_INDEX\_TYPE} CMake option and
  added the \newline 
  \id{SUNDIALS\_INDEX\_SIZE} CMake option to select the \id{sunindextype}
  integer size.
\item The native CMake FindMPI module is now used to locate an MPI installation.
\item If MPI is enabled and MPI compiler wrappers are not set, the build system 
  will check if \id{CMAKE\_<language>\_COMPILER} can compile MPI programs before
  trying to locate and use an MPI installation.
\item The previous options for setting MPI compiler wrappers and the executable
  for running MPI programs have been have been depreated. The new options that
  align with those used in native CMake FindMPI module are
  \id{MPI\_C\_COMPILER}, \id{MPI\_CXX\_COMPILER}, \id{MPI\_Fortran\_COMPILER},
  and \id{MPIEXEC\_EXECUTABLE}.
\item When a Fortran name-mangling scheme is needed (e.g., \id{LAPACK\_ENABLE}
  is \id{ON}) the build system will infer the scheme from the Fortran
  compiler. If a Fortran compiler is not available or the inferred or default
  scheme needs to be overridden, the advanced options
  \id{SUNDIALS\_F77\_FUNC\_CASE} and \id{SUNDIALS\_F77\_FUNC\_UNDERSCORES} can
  be used to manually set the name-mangling scheme and bypass trying to infer
  the scheme. 
\item Parts of the main CMakeLists.txt file were moved to new files in the
  \id{src} and \id{example} directories to make the CMake configuration file
  structure more modular.
\end{itemize}

\subsection*{Changes in v3.1.2}

The changes in this minor release include the following:
\begin{itemize}
\item Updated the minimum required version of CMake to 2.8.12 and enabled
  using rpath by default to locate shared libraries on OSX.
\item Fixed Windows specific problem where \id{sunindextype} was not correctly 
  defined when using 64-bit integers for the {\sundials} index type. On Windows
  \id{sunindextype} is now defined as the MSVC basic type \id{\_\_int64}.
\item Added sparse SUNMatrix ``Reallocate'' routine to allow specification of
  the nonzero storage.
\item Updated the KLU SUNLinearSolver module to set constants for the two
  reinitialization types, and fixed a bug in the full reinitialization
  approach where the sparse SUNMatrix pointer would go out of scope on
  some architectures.
\item Updated the ``ScaleAdd'' and ``ScaleAddI'' implementations in the
  sparse SUNMatrix module to more optimally handle the case where the
  target matrix contained sufficient storage for the sum, but had the
  wrong sparsity pattern.  The sum now occurs in-place, by performing
  the sum backwards in the existing storage.  However, it is still more
  efficient if the user-supplied Jacobian routine allocates storage for
  the sum $I+\gamma J$ manually (with zero entries if needed).
\item Added new example, \id{cvRoberts\_FSA\_dns\_Switch.c}, which demonstrates 
  switching on/off forward sensitivity computations. This example came from
  the usage notes page of the SUNDIALS website.
\item The misnamed function \id{CVSpilsSetJacTimesSetupFnBS} has been
  deprecated and replaced by \id{CVSpilsSetJacTimesBS}. The deprecated
  function \id{CVSpilsSetJacTimesSetupFnBS} will be removed in the next
  major release.
\item Changed the LICENSE install path to \id{instdir/include/sundials}.
\end{itemize}

\subsection*{Changes in v3.1.1}

The changes in this minor release include the following:
\begin{itemize}
\item Fixed a minor bug in the cvSLdet routine, where a return was missing
  in the error check for three inconsistent roots.

\item Fixed a potential memory leak in the {\spgmr} and {\spfgmr} linear
  solvers: if ``Initialize'' was called multiple times then the solver
  memory was reallocated (without being freed).
  
\item Updated KLU SUNLinearSolver module to use a \id{typedef} for the
  precision-specific solve function to be used (to avoid compiler 
  warnings).  

\item Added missing typecasts for some \id{(void*)} pointers (again, to
  avoid compiler warnings). 

\item Bugfix in \id{sunmatrix\_sparse.c} where we had used \id{int}
  instead of \id{sunindextype} in one location.

\item Added missing \id{\#include <stdio.h>} in {\nvector} and {\sunmatrix}
  header files.

\item Fixed an indexing bug in the {\cuda} {\nvector} implementation of
  \id{N\_VWrmsNormMask} and revised the {\raja} {\nvector} implementation of
  \id{N\_VWrmsNormMask} to work with mask arrays using values other than zero or
  one. Replaced \id{double} with \id{realtype} in the RAJA vector test functions.
\end{itemize}
In addition to the changes above, minor corrections were also made to the
example programs, build system, and user documentation.

\subsection*{Changes in v3.1.0}

Added {\nvector} print functions that write vector data to a specified
file (e.g., \id{N\_VPrintFile\_Serial}).

Added \id{make test} and \id{make test\_install} options to the build
system for testing {\sundials} after building with \id{make} and
installing with \id{make install} respectively.

\subsection*{Changes in v3.0.0}

All interfaces to matrix structures and linear solvers 
have been reworked, and all example programs have been updated. 
The goal of the redesign of these interfaces was to provide more encapsulation
and ease in interfacing custom linear solvers and interoperability 
with linear solver libraries.
Specific changes include:
\begin{itemize}
\item Added generic SUNMATRIX module with three provided implementations:
        dense, banded and sparse.  These replicate previous SUNDIALS Dls and
        Sls matrix structures in a single object-oriented API.
\item Added example problems demonstrating use of generic SUNMATRIX modules.
\item Added generic SUNLINEARSOLVER module with eleven provided
        implementations: dense, banded, LAPACK dense, LAPACK band, KLU,
        SuperLU\_MT, SPGMR, SPBCGS, SPTFQMR, SPFGMR, PCG.  These replicate
        previous SUNDIALS generic linear solvers in a single object-oriented
        API.
\item Added example problems demonstrating use of generic SUNLINEARSOLVER
        modules.
\item Expanded package-provided direct linear solver (Dls) interfaces and
        scaled, preconditioned, iterative linear solver (Spils) interfaces
        to utilize generic SUNMATRIX and SUNLINEARSOLVER objects.
\item Removed package-specific, linear solver-specific, solver modules
        (e.g. CVDENSE, KINBAND, IDAKLU, ARKSPGMR) since their functionality
        is entirely replicated by the generic Dls/Spils interfaces and
        SUNLINEARSOLVER/SUNMATRIX modules.  The exception is CVDIAG, a
        diagonal approximate Jacobian solver available to CVODE and CVODES.
\item Converted all SUNDIALS example problems to utilize new generic
        SUNMATRIX and SUNLINEARSOLVER objects, along with updated Dls and
        Spils linear solver interfaces.
\item Added Spils interface routines to ARKode, CVODE, CVODES, IDA and
        IDAS to allow specification of a user-provided "JTSetup" routine.
        This change supports users who wish to set up data structures for
        the user-provided Jacobian-times-vector ("JTimes") routine, and
        where the cost of one JTSetup setup per Newton iteration can be
        amortized between multiple JTimes calls.
\end{itemize}

Two additional {\nvector} implementations were added -- one for
CUDA and one for RAJA vectors.  
These vectors are supplied to provide very basic support for running
on GPU architectures.  Users are advised that these vectors both move all data
to the GPU device upon construction, and speedup will only be realized if the
user also conducts the right-hand-side function evaluation on the device.
In addition, these vectors assume the problem fits on one GPU.
Further information about RAJA, users are referred to th web site, 
https://software.llnl.gov/RAJA/.
These additions are accompanied by additions to various interface functions
and to user documentation.

All indices for data structures were updated to a new \id{sunindextype} that
can be configured to be a 32- or 64-bit integer data index type. 
\id{sunindextype} is defined to be \id{int32\_t} or \id{int64\_t} when portable types are
supported, otherwise it is defined as \id{int} or \id{long int}.
The Fortran interfaces continue to use \id{long int} for indices, except for 
their sparse matrix interface that now uses the new \id{sunindextype}.
This new flexible capability for index types includes interfaces to 
PETSc, hypre, SuperLU\_MT, and KLU with 
either 32-bit or 64-bit capabilities depending how the user configures 
{\sundials}.

To avoid potential namespace conflicts, the macros defining \id{booleantype}
values \id{TRUE} and \id{FALSE} have been changed to \id{SUNTRUE} and
\id{SUNFALSE} respectively.

Temporary vectors were removed from preconditioner setup and solve
routines for all packages.  It is assumed that all necessary data
for user-provided preconditioner operations will be allocated and
stored in user-provided data structures.

The file \id{include/sundials\_fconfig.h} was added. This file contains 
{\sundials} type information for use in Fortran programs.

Added functions \id{SUNDIALSGetVersion} and \id{SUNDIALSGetVersionNumber} to
get {\sundials} release version information at runtime.

The build system was expanded to support many of the xSDK-compliant keys. 
The xSDK is a movement in scientific software to provide a foundation for the
rapid and efficient production of high-quality, 
sustainable extreme-scale scientific applications.  More information can
be found at, https://xsdk.info.

In addition, numerous changes were made to the build system.
These include the addition of separate \id{BLAS\_ENABLE} and \id{BLAS\_LIBRARIES} 
CMake variables, additional error checking during CMake configuration,
minor bug fixes, and renaming CMake options to enable/disable examples 
for greater clarity and an added option to enable/disable Fortran 77 examples.
These changes included changing \id{EXAMPLES\_ENABLE} to \id{EXAMPLES\_ENABLE\_C}, 
changing \id{CXX\_ENABLE} to \id{EXAMPLES\_ENABLE\_CXX}, changing \id{F90\_ENABLE} to 
\id{EXAMPLES\_ENABLE\_F90}, and adding an \id{EXAMPLES\_ENABLE\_F77} option.

A bug fix was made in \id{CVodeFree} to call \id{lfree} unconditionally 
(if non-NULL).
 
Corrections and additions were made to the examples, 
to installation-related files,
and to the user documentation.


\subsection*{Changes in v2.9.0}

Two additional {\nvector} implementations were added -- one for
Hypre (parallel) ParVector vectors, and one for {\petsc} vectors.  These
additions are accompanied by additions to various interface functions
and to user documentation.

Each {\nvector} module now includes a function, \id{N\_VGetVectorID},
that returns the {\nvector} module name.

A bug was fixed in the interpolation functions used in solving
backward problems for adjoint sensitivity analysis.

For each linear solver, the various solver performance counters are
now initialized to 0 in both the solver specification function and in
solver \id{linit} function.  This ensures that these solver counters
are initialized upon linear solver instantiation as well as at the
beginning of the problem solution.

A memory leak was fixed in the banded preconditioner interface.
In addition, updates were done to return integers from linear solver 
and preconditioner 'free' functions.

The Krylov linear solver Bi-CGstab was enhanced by removing a redundant
dot product.  Various additions and corrections were made to the
interfaces to the sparse solvers KLU and SuperLU\_MT, including support
for CSR format when using KLU.

In interpolation routines for backward problems, added logic to bypass 
sensitivity interpolation if input sensitivity argument is NULL.

New examples were added for use of sparse direct solvers within sensitivity
integrations and for use of openMP.  

Minor corrections and additions were made to the {\cvodes} solver, to the
examples, to installation-related files, and to the user documentation.

\subsection*{Changes in v2.8.0}

Two major additions were made to the linear system solvers that are
available for use with the {\cvodes} solver.  First, in the serial case,
an interface to the sparse direct solver KLU was added.
Second, an interface to SuperLU\_MT, the multi-threaded version of
SuperLU, was added as a thread-parallel sparse direct solver option,
to be used with the serial version of the NVECTOR module.
As part of these additions, a sparse matrix (CSC format) structure 
was added to {\cvodes}.

Otherwise, only relatively minor modifications were made to the
{\cvodes} solver:

In \id{cvRootfind}, a minor bug was corrected, where the input
array \id{rootdir} was ignored, and a line was added to break out of
root-search loop if the initial interval size is below the tolerance
\id{ttol}.

In \id{CVLapackBand}, the line \id{smu = MIN(N-1,mu+ml)} was changed to
\id{smu = mu + ml} to correct an illegal input error for \id{DGBTRF/DGBTRS}.

Some minor changes were made in order to minimize the differences
between the sources for private functions in {\cvodes} and {\cvode}.

An option was added in the case of Adjoint Sensitivity Analysis with
dense or banded Jacobian:  With a call to \id{CVDlsSetDenseJacFnBS} or
\id{CVDlsSetBandJacFnBS}, the user can specify a user-supplied Jacobian
function of type \id{CVDls***JacFnBS}, for the case where the backward
problem depends on the forward sensitivities.

In \id{CVodeQuadSensInit}, the line \id{cv\_mem->cv\_fQS\_data = ...}
was corrected (missing \id{Q}).

In the User Guide, a paragraph was added in Section 6.2.1 on
\id{CVodeAdjReInit}, and a paragraph was added in Section 6.2.9 on
\id{CVodeGetAdjY}.  In the example \id{cvsRoberts\_ASAi\_dns}, the output
was revised to include the use of \id{CVodeGetAdjY}.

Two minor bugs were fixed regarding the testing of input on the first
call to \id{CVode} -- one involving \id{tstop} and one involving the
initialization of \id{*tret}.

For the Adjoint Sensitivity Analysis case in which the backward problem
depends on the forward sensitivities, options have been added to allow
for user-supplied \id{pset}, \id{psolve}, and \id{jtimes} functions.

In order to avoid possible name conflicts, the mathematical macro
and function names \id{MIN}, \id{MAX}, \id{SQR}, \id{RAbs}, \id{RSqrt},
\id{RExp}, \id{RPowerI}, and \id{RPowerR} were changed to
\id{SUNMIN}, \id{SUNMAX}, \id{SUNSQR}, \id{SUNRabs}, \id{SUNRsqrt},
\id{SUNRexp}, \id{SRpowerI}, and \id{SUNRpowerR}, respectively.
These names occur in both the solver and example programs.

In the example \id{cvsHessian\_ASA\_FSA}, an error was corrected in the
function \id{fB2}: \id{y2} in place of \id{y3} in the third term of
\id{Ith(yBdot,6)}.

Two new {\nvector} modules have been added for thread-parallel computing
environments --- one for openMP, denoted \id{NVECTOR\_OPENMP},
and one for Pthreads, denoted \id{NVECTOR\_PTHREADS}.

With this version of {\sundials}, support and documentation of the
Autotools mode of installation is being dropped, in favor of the
CMake mode, which is considered more widely portable.

\subsection*{Changes in v2.7.0}

One significant design change was made with this release: The problem
size and its relatives, bandwidth parameters, related internal indices,
pivot arrays, and the optional output \id{lsflag} have all been
changed from type \id{int} to type \id{long int}, except for the
problem size and bandwidths in user calls to routines specifying
BLAS/LAPACK routines for the dense/band linear solvers.  The function
\id{NewIntArray} is replaced by a pair \id{NewIntArray}/\id{NewLintArray},
for \id{int} and \id{long int} arrays, respectively.  In a minor
change to the user interface, the type of the index \id{which} in
CVODES was changed from \id{long int} to \id{int}.

Errors in the logic for the integration of backward problems were
identified and fixed.

A large number of minor errors have been fixed.  Among these are the following:
In \id{CVSetTqBDF}, the logic was changed to avoid a divide by zero.
After the solver memory is created, it is set to zero before being filled.
In each linear solver interface function, the linear solver memory is
freed on an error return, and the \id{**Free} function now includes a
line setting to NULL the main memory pointer to the linear solver memory.
In the rootfinding functions \id{CVRcheck1}/\id{CVRcheck2}, when an exact
zero is found, the array \id{glo} of $g$ values at the left endpoint is
adjusted, instead of shifting the $t$ location \id{tlo} slightly.
In the installation files, we modified the treatment of the macro
SUNDIALS\_USE\_GENERIC\_MATH, so that the parameter GENERIC\_MATH\_LIB is
either defined (with no value) or not defined.

\subsection*{Changes in v2.6.0}

Two new features related to the integration of ODE IVP problems were added 
in this release: (a) a new linear solver module, based on Blas and Lapack 
for both dense and banded matrices, and (b) an option to specify which direction 
of zero-crossing is to be monitored while performing rootfinding. 

This version also includes several new features related to sensitivity analysis,
among which are: (a) support for integration of quadrature equations depending
on both the states and forward sensitivity (and thus support for forward sensitivity
analysis of quadrature equations), (b) support for simultaneous integration of 
multiple backward problems based on the same underlying ODE (e.g., for use
in an {\em forward-over-adjoint} method for computing second order derivative
information), (c) support for backward integration of ODEs and quadratures 
depending on both forward states and sensitivities (e.g., for use in computing 
second-order derivative information), and (d) support for reinitialization of 
the adjoint module.

The user interface has been further refined. Some of the API changes involve:
(a) a reorganization of all linear solver modules into two families (besides 
the existing family of scaled preconditioned iterative linear solvers,
the direct solvers, including the new Lapack-based ones, were also organized 
into a {\em direct} family); (b) maintaining a single pointer to user data,
optionally specified through a \id{Set}-type function; and (c) a general 
streamlining of the preconditioner modules distributed with the solver.
Moreover, the prototypes of all functions related to integration of backward 
problems were modified to support the simultaneous integration of multiple 
problems. All backward problems defined by the user are internally managed
through a linked list and identified in the user interface through a
unique identifier.


\subsection*{Changes in v2.5.0}

The main changes in this release involve a rearrangement of the entire 
{\sundials} source tree (see \S\ref{ss:sun_org}). At the user interface 
level, the main impact is in the mechanism of including {\sundials} header
files which must now include the relative path (e.g. \id{\#include <cvode/cvode.h>}).
Additional changes were made to the build system: all exported header files are
now installed in separate subdirectories of the instaltion {\em include} directory.

In the adjoint solver module, the following two bugs were fixed: in \id{CVodeF}
the solver was sometimes incorrectly taking an additional step before
returning control to the user (in \id{CV\_NORMAL} mode) thus leading to 
a failure in the interpolated output function; in \id{CVodeB}, while searching
for the current check point, the solver was sometimes reaching outside the
integration interval resulting in a segmentation fault.

The functions in the generic dense linear solver (\id{sundials\_dense} and
\id{sundials\_smalldense}) were modified to work for rectangular $m \times n$
matrices ($m \le n$), while the factorization and solution functions were
renamed to \id{DenseGETRF}/\id{denGETRF} and \id{DenseGETRS}/\id{denGETRS}, 
respectively.
The factorization and solution functions in the generic band linear solver were 
renamed \id{BandGBTRF} and \id{BandGBTRS}, respectively.

\subsection*{Changes in v2.4.0}

{\cvspbcg} and {\cvsptfqmr} modules have been added to interface with the
Scaled Preconditioned Bi-CGstab ({\spbcg}) and Scaled Preconditioned
Transpose-Free Quasi-Minimal Residual ({\sptfqmr}) linear solver modules,
respectively (for details see Chapter \ref{s:simulation}).
At the same time, function type names for Scaled Preconditioned Iterative
Linear Solvers were added for the user-supplied Jacobian-times-vector and
preconditioner setup and solve functions.

A new interpolation method was added to the {\cvodes} adjoint module. The
function \id{CVadjMalloc} has an additional argument which can be used to select
the desired interpolation scheme.

The deallocation functions now take as arguments the address of the respective 
memory block pointer.

To reduce the possibility of conflicts, the names of all header files have
been changed by adding unique prefixes (\id{cvodes\_} and \id{sundials\_}).
When using the default installation procedure, the header files are exported
under various subdirectories of the target \id{include} directory. For more
details see Appendix \ref{c:install}.

\subsection*{Changes in v2.3.0}

A minor bug was fixed in the interpolation functions of the adjoint
{\cvodes} module.

\subsection*{Changes in v2.2.0}

The user interface has been further refined. Several functions used
for setting optional inputs were combined into a single one.  An optional
user-supplied routine for setting the error weight vector was added.
Additionally, to resolve potential variable scope issues, all
SUNDIALS solvers release user data right after its use. The build
systems has been further improved to make it more robust.

\subsection*{Changes in v2.1.2}

A bug was fixed in the \id{CVode} function that was potentially
leading to erroneous behaviour of the rootfinding procedure on the 
integration first step.

\subsection*{Changes in v2.1.1}

This {\cvodes} release includes bug fixes related to forward sensitivity
computations (possible loss of accuray on a BDF order increase and incorrect
logic in testing user-supplied absolute tolerances). 
In addition, we have added the option of activating and deactivating
forward sensitivity calculations on successive {\cvodes} runs without memory
allocation/deallocation.

Other changes in this minor {\sundials} release affect the build system.

\subsection*{Changes in v2.1.0}

The major changes from the previous version involve a redesign of the
user interface across the entire {\sundials} suite. We have eliminated the
mechanism of providing optional inputs and extracting optional statistics 
from the solver through the \id{iopt} and \id{ropt} arrays. Instead,
{\cvodes} now provides a set of routines (with prefix \id{CVodeSet})
to change the default values for various quantities controlling the
solver and a set of extraction routines (with prefix \id{CVodeGet})
to extract statistics after return from the main solver routine.
Similarly, each linear solver module provides its own set of {\id{Set}-}
and {\id{Get}-type} routines. For more details see \S\ref{ss:optional_input}
and \S\ref{ss:optional_output}.

Additionally, the interfaces to several user-supplied routines
(such as those providing Jacobians, preconditioner information, and
sensitivity right hand sides) were simplified by reducing the number
of arguments. The same information that was previously accessible
through such arguments can now be obtained through {\id{Get}-type}
functions.

The rootfinding feature was added, whereby the roots of a set of given
functions may be computed during the integration of the ODE system.

Installation of {\cvodes} (and all of {\sundials}) has been completely 
redesigned and is now based on configure scripts.


\section{Reading this User Guide}\label{ss:reading}

This user guide is a combination of general usage instructions. 
Specific example programs are provided as a separate document.  
We expect that some readers will want to
concentrate on the general instructions, while others will refer
mostly to the examples, and the organization is intended to
accommodate both styles.

There are different possible levels of usage of {\cvodes}. The most
casual user, with a small IVP problem only, can get by with reading
\S\ref{ss:ivp_sol}, then Chapter \ref{s:simulation} through
\S\ref{sss:cvode} only, and looking at examples in~\cite{cvodes_ex}.
In addition, to solve a forward sensitivity problem the user should read 
\S\ref{ss:fwd_sensi}, followed by Chapter \ref{s:forward} through 
\S\ref{ss:sensi_get} only, and look at examples in~\cite{cvodes_ex}.

In a different direction, a more expert user with an IVP problem may want to
(a) use a package preconditioner (\S\ref{ss:preconds}), 
(b) supply his/her own Jacobian or preconditioner routines (\S\ref{ss:user_fct_sim}),
(c) do multiple runs of problems of the same size (\S\ref{sss:cvreinit}), 
(d) supply a new {\nvector} module (Chapter \ref{s:nvector}), or even 
(e) supply new {\sunlinsol} and/or {\sunmatrix} modules (Chapters
\ref{s:sunmatrix} and \ref{s:sunlinsol}).
%
An advanced user with a forward sensitivity problem may also want to
(a) provide his/her own sensitivity equations right-hand side routine
(\S\ref{s:user_fct_fwd}), (b) perform multiple runs with the same number of
sensitivity parameters (\S\ref{ss:sensi_malloc}), or (c) extract additional
diagnostic information (\S\ref{ss:sensi_get}).
%
A user with an adjoint sensitivity problem needs to understand the IVP 
solution approach at the desired level and also go through 
\S\ref{ss:adj_sensi} for a short mathematical description of the adjoint
approach, Chapter \ref{s:adjoint} for the usage of the adjoint module in {\cvodes},
and the examples in~\cite{cvodes_ex}.

The structure of this document is as follows:
\begin{itemize}
\item
  In Chapter \ref{s:math}, we give short descriptions of the numerical 
  methods implemented by {\cvodes} for the solution of initial value problems
  for systems of ODEs, continue with short descriptions of preconditioning
  (\S\ref{s:preconditioning}), stability limit detection (\S\ref{s:bdf_stab}),
  and rootfinding (\S\ref{ss:rootfinding}), and conclude with an overview of the
  mathematical aspects of sensitivity analysis, both forward (\S\ref{ss:fwd_sensi})
  and adjoint (\S\ref{ss:adj_sensi}).
\item
  The following chapter describes the structure of the {\sundials} suite
  of solvers (\S\ref{ss:sun_org}) and the software organization of the {\cvodes}
  solver (\S\ref{ss:cvodes_org}). 
\item
  Chapter \ref{s:simulation} is the main usage document for {\cvodes}
  for simulation applications.  It includes a complete description of
  the user interface for the integration of ODE initial value problems.
  Readers that are not interested in using {\cvodes} for sensitivity
  analysis can then skip the next two chapters.
\item
  Chapter \ref{s:forward} describes the usage of {\cvodes} for forward
  sensitivity analysis as an extension of its IVP integration
  capabilities.  We begin with a skeleton of the user main program,
  with emphasis on the steps that are required in addition to those
  already described in Chapter \ref{s:simulation}.  Following that we
  provide detailed descriptions of the user-callable interface
  routines specific to forward sensitivity analysis and of the
  additonal optional user-defined routines.
\item
  Chapter \ref{s:adjoint} describes the usage of {\cvodes} for adjoint
  sensitivity analysis. We begin by describing the {\cvodes} checkpointing 
  implementation for interpolation of the original IVP solution during
  integration of the adjoint system backward in time, and with 
  an overview of a user's main program. Following that we provide complete
  descriptions of the user-callable interface routines for adjoint sensitivity
  analysis as well as descriptions of the required additional user-defined routines.
\item
  Chapter \ref{s:nvector} gives a brief overview of the generic
  {\nvector} module shared among the various components of
  {\sundials}, and details on the {\nvector} implementations
  provided with {\sundials}.
\item
  Chapter \ref{s:sunmatrix} gives a brief overview of the generic
  {\sunmatrix} module shared among the various components of
  {\sundials}, and details on the {\sunmatrix} implementations
  provided with {\sundials}: 
  a dense implementation (\S\ref{ss:sunmat_dense}),
  a banded implementation (\S\ref{ss:sunmat_band}) and
  a sparse implementation (\S\ref{ss:sunmat_sparse}).
\item
  Chapter \ref{s:sunlinsol} gives a brief overview of the generic
  {\sunlinsol} module shared among the various components of
  {\sundials}.  This chapter contains details on the {\sunlinsol}
  implementations provided with {\sundials}.
  The chapter
  also contains details on the {\sunlinsol} implementations provided
  with {\sundials} that interface with external linear solver
  libraries.
\item
  Finally, in the appendices, we provide detailed instructions for the installation
  of {\cvodes}, within the structure of {\sundials} (Appendix \ref{c:install}), as well
  as a list of all the constants used for input to and output from {\cvodes} functions
  (Appendix \ref{c:constants}).
\end{itemize}

Finally, the reader should be aware of the following notational conventions
in this user guide:  program listings and identifiers (such as \id{CVodeInit}) 
within textual explanations appear in typewriter type style; 
fields in {\CC} structures (such as {\em content}) appear in italics;
and packages or modules, such as {\cvdls}, are written in all capitals. 
Usage and installation instructions that constitute important warnings
are marked with a triangular symbol {\warn} in the margin.

%---------------------------------
% License information section
\input{license_info}
%---------------------------------
