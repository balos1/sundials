% This is a shared SUNDIALS TEX file with description of
% the PETSc nvector wrapper implementation
%
\section{The NVECTOR\_PETSC implementation}\label{ss:nvec_petsc}

The {\nvecpetsc} module is an {\nvector} wrapper around the {\petsc} vector.
It defines the {\em content} field of a \id{N\_Vector} to be a structure containing
the global and local lengths of the vector, a pointer to the {\petsc} vector,
an {\mpi} communicator, and a boolean flag {\em own\_data} indicating ownership of 
the wrapped {\petsc} vector.
%%
\begin{verbatim} 
struct _N_VectorContent_Petsc {
  sunindextype local_length;
  sunindextype global_length;
  booleantype own_data;
  Vec *pvec;
  MPI_Comm comm;
};
\end{verbatim}
%%
%%--------------------------------------------
The header file to include when using this module is \id{nvector\_petsc.h}.
The installed module library to link to is
\id{libsundials\_nvecpetsc.\textit{lib}}
where \id{\em.lib} is typically \id{.so} for shared libraries and \id{.a}
for static libraries.

Unlike native {\sundials} vector types, {\nvecpetsc} does not provide macros 
to access its member variables.
Note that {\nvecpetsc} requires {\sundials} to be built with {\mpi} support.


% ====================================================================
\subsection{NVECTOR\_PETSC functions}
\label{ss:nvec_petsc_functions}
% ====================================================================

The {\nvecpetsc} module defines implementations of all vector operations listed 
in Tables \ref{ss:nvecops}, \ref{ss:nvecfusedops}, \ref{ss:nvecarrayops},
and \ref{ss:nveclocalops}, except for
\id{N\_VGetArrayPointer} and \id{N\_VSetArrayPointer}. As such, this vector cannot be
used with {\sundials} Fortran interfaces.
When access to raw vector data is needed, it is 
recommended to extract the {\petsc} vector first, and then use {\petsc} 
methods to access the data. Usage examples of {\nvecpetsc} are provided in
example programs for {\ida} \cite{ida_ex}.

The names of vector operations are obtained from those in 
Tables \ref{ss:nvecops}, \ref{ss:nvecfusedops}, \ref{ss:nvecarrayops}, and
\ref{ss:nveclocalops} by appending the
suffix \id{\_Petsc} (e.g. \id{N\_VDestroy\_Petsc}).
The module {\nvecpetsc}  provides the following additional user-callable routines:
%%--------------------------------------
\sunmodfun{N\_VNewEmpty\_Petsc}
{ 
  This function creates a new {\nvector} wrapper with the pointer to
  the wrapped {\petsc} vector set to (\id{NULL}). It is used by the 
  \id{N\_VMake\_Petsc} and \id{N\_VClone\_Petsc} implementations. 
}
{
  N\_Vector N\_VNewEmpty\_Petsc(MPI\_Comm comm, sunindextype local\_length, 
  \newlinefill{N\_Vector N\_VNewEmpty\_Petsc}
  sunindextype global\_length)
}
%%--------------------------------------
\sunmodfun{N\_VMake\_Petsc}
{  
  This function creates and allocates memory for an {\nvecpetsc}
  wrapper around a user-provided {\petsc} vector. It does {\em not} 
  allocate memory for the vector \id{pvec} itself.
}
{
  N\_Vector N\_VMake\_Petsc(Vec *pvec)
}
%%--------------------------------------
\sunmodfun{N\_VGetVector\_Petsc}
{  
  This function returns a pointer to the underlying {\petsc} vector.
}
{
  Vec *N\_VGetVector\_Petsc(N\_Vector v)
}
%%--------------------------------------
\sunmodfun{N\_VCloneVectorArray\_Petsc}
{ 
  This function creates (by cloning) an array of \id{count} {\nvecpetsc} vectors.
}
{
  N\_Vector *N\_VCloneVectorArray\_Petsc(int count, N\_Vector w)
}
%%--------------------------------------
\sunmodfun{N\_VCloneVectorArrayEmpty\_Petsc}
{ 
  This function creates (by cloning) an array of \id{count} {\nvecpetsc} vectors,
  each with pointers to {\petsc} vectors set to (\id{NULL}).
}
{
  N\_Vector *N\_VCloneVectorArrayEmpty\_Petsc(int count, N\_Vector w)
}
%%--------------------------------------
\sunmodfun{N\_VDestroyVectorArray\_Petsc}
{
  This function frees memory allocated for the array of \id{count} variables of
  type \id{N\_Vector} created with \id{N\_VCloneVectorArray\_Petsc} or with
  \id{N\_VCloneVectorArrayEmpty\_Petsc}.
}
{
  void N\_VDestroyVectorArray\_Petsc(N\_Vector *vs, int count)
}
%%--------------------------------------
\sunmodfun{N\_VPrint\_Petsc}
{
  This function prints the global content of a wrapped {\petsc} vector to \id{stdout}.
}
{
  void N\_VPrint\_Petsc(N\_Vector v)
}
%%--------------------------------------
\sunmodfun{N\_VPrintFile\_Petsc}
{  
  This function prints the global content of a wrapped {\petsc} vector to \id{fname}.
}
{
  void N\_VPrintFile\_Petsc(N\_Vector v, const char fname[])
}
%%--------------------------------------

By default all fused and vector array operations are disabled in the {\nvecpetsc}
module. The following additional user-callable routines are provided to
enable or disable fused and vector array operations for a specific vector. To
ensure consistency across vectors it is recommended to first create a vector
with \id{N\_VMake\_Petsc}, enable/disable the desired operations for that vector
with the functions below, and create any additional vectors from that vector
using \id{N\_VClone}. This guarantees the new vectors will have the same
operations enabled/disabled as cloned vectors inherit the same enable/disable
options as the vector they are cloned from while vectors created with
\id{N\_VMake\_Petsc} will have the default settings for the {\nvecpetsc} module.
%%--------------------------------------
\sunmodfun{N\_VEnableFusedOps\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) all fused and
  vector array operations in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableFusedOps\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableLinearCombination\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the linear
  combination fused operation in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableLinearCombination\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableScaleAddMulti\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the scale and
  add a vector to multiple vectors fused operation in the {\petsc} vector. The
  return value is \id{0} for success and \id{-1} if the input vector or its
  \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableScaleAddMulti\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableDotProdMulti\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the multiple
  dot products fused operation in the {\petsc} vector. The return value is \id{0}
  for success and \id{-1} if the input vector or its \id{ops} structure are
  \id{NULL}.
}
{
  int N\_VEnableDotProdMulti\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableLinearSumVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the linear sum
  operation for vector arrays in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableLinearSumVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableScaleVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the scale
  operation for vector arrays in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableScaleVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableConstVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the const
  operation for vector arrays in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableConstVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableWrmsNormVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the WRMS norm
  operation for vector arrays in the {\petsc} vector. The return value is \id{0} for
  success and \id{-1} if the input vector or its \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableWrmsNormVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableWrmsNormMaskVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the masked WRMS
  norm operation for vector arrays in the {\petsc} vector. The return value is
  \id{0} for success and \id{-1} if the input vector or its \id{ops} structure are
  \id{NULL}.
}
{
  int N\_VEnableWrmsNormMaskVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableScaleAddMultiVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the scale and
  add a vector array to multiple vector arrays operation in the {\petsc} vector. The
  return value is \id{0} for success and \id{-1} if the input vector or its
  \id{ops} structure are \id{NULL}.
}
{
  int N\_VEnableScaleAddMultiVectorArray\_Petsc(N\_Vector v, booleantype tf)
}
%%--------------------------------------
\sunmodfun{N\_VEnableLinearCombinationVectorArray\_Petsc}
{
  This function enables (\id{SUNTRUE}) or disables (\id{SUNFALSE}) the linear
  combination operation for vector arrays in the {\petsc} vector. The return value
  is \id{0} for success and \id{-1} if the input vector or its \id{ops} structure
  are \id{NULL}.
}
{
  int N\_VEnableLinearCombinationVectorArray\_Petsc(N\_Vector v,
  \newlinefill{int N\_VEnableLinearCombinationVectorArray\_Petsc}
  booleantype tf)
}
%%
%%------------------------------------
%%
\paragraph{\bf Notes} 
           
\begin{itemize}
                                        
\item
  When there is a need to access components of an \id{N\_Vector\_Petsc}, \id{v}, 
  it is recommeded to extract the {\petsc} vector via       
  \id{x\_vec = N\_VGetVector\_Petsc(v)} and then access components using 
  appropriate {\petsc} functions.        
                                                               
\item
  {\warn}The functions \id{N\_VNewEmpty\_Petsc}, \id{N\_VMake\_Petsc}, and
  \id{N\_VCloneVectorArrayEmpty\_Petsc} set the field {\em own\_data} to \id{SUNFALSE}.   
  \id{N\_VDestroy\_Petsc} and \id{N\_VDestroyVectorArray\_Petsc}
  will not attempt to free the pointer {\em pvec} for any \id{N\_Vector} with
  {\em own\_data} set to \id{SUNFALSE}. In such a case, it is the user's responsibility to
  deallocate the {\em pvec} pointer.

\item
  {\warn}To maximize efficiency, vector operations in the {\nvecpetsc} implementation
  that have more than one \id{N\_Vector} argument do not check for
  consistent internal representations of these vectors. It is the user's 
  responsibility to ensure that such routines are called with \id{N\_Vector}
  arguments that were all created with the same internal representations.

\end{itemize}

