% This is a shared SUNDIALS TEX file with description of
% the Trilinos nvector wrapper implementation
%
\section{The NVECTOR\_TRILINOS implementation}\label{ss:nvec_trilinos}

The {\nvectrilinos} module is an {\nvector} wrapper around the {\trilinos}
\href{https://github.com/trilinos/Trilinos}{Tpetra} vector. The interface
to Tpetra is implemented in the \id{Sundials::TpetraVectorInterface} class. This
class simply stores a reference counting pointer to a Tpetra vector and
inherits from an empty structure
%%
\begin{verbatim}
struct _N_VectorContent_Trilinos {};
\end{verbatim}
%%
%%--------------------------------------------
to interface the C++ class with the {\nvector} C code.
A pointer to an instance of this class is kept in the \id{content} field
of the \id{N\_Vector} object, to ensure that the Tpetra vector
is not deleted for as long as the \id{N\_Vector} object exists.

The Tpetra vector type in the \id{Sundials::TpetraVectorInterface} class is defined
as:
\begin{verbatim}
  typedef Tpetra::Vector<realtype, sunindextype, sunindextype> vector_type;
\end{verbatim}
The Tpetra vector will use the {\sundials}-specified \id{realtype} as its scalar
type, and it will use \id{sunindextype} as the global and the local ordinal types.
This type definition will use Tpetra's default node type. Available Kokkos node
types in {\trilinos} 12.14 release are serial (single thread), OpenMP, Pthread,
and {\cuda}. The default node type is selected when building the Kokkos package.
For example, the Tpetra vector will use a {\cuda} node if Tpetra was built with
{\cuda} support and the {\cuda} node was selected as the default when Tpetra was
built.

The header file to include when using this module is \id{nvector\_trilinos.h}.
The installed module library to link to is
\id{libsundials\_nvectrilinos.\textit{lib}}
where \id{\em.lib} is typically \id{.so} for shared libraries and \id{.a}
for static libraries.


% ====================================================================
\subsection{NVECTOR\_TRILINOS functions}
\label{ss:nvec_trilinos_functions}
% ====================================================================

The {\nvectrilinos} module defines implementations of all vector operations listed
in Tables \ref{ss:nvecops}, \ref{ss:nveclocalops}, and
\ref{ss:nveclocalops}, except for \verb|N_VGetArrayPointer| and
\verb|N_VSetArrayPointer|. As such, this vector cannot be used with
{\sundials} Fortran interfaces, nor with the {\sundials} direct
solvers and preconditioners. When access to raw vector data is needed, it is
recommended to extract the {\trilinos} Tpetra vector first, and then use Tpetra vector
methods to access the data. Usage examples of {\nvectrilinos} are provided in
example programs for {\ida} \cite{ida_ex}.

The names of vector operations are obtained from those in
Tables \ref{ss:nvecops}, \ref{ss:nveclocalops}, and \ref{ss:nveclocalops} by appending the
suffix \id{\_Trilinos} (e.g. \id{N\_VDestroy\_Trilinos}).
Vector operations call existing \id{Tpetra::Vector} methods when available. Vector
operations specific to {\sundials} are implemented as standalone functions in the namespace
\id{Sundials::TpetraVector}, located in the file \id{SundialsTpetraVectorKernels.hpp}.
The module {\nvectrilinos} provides the following additional user-callable functions:
%%
%%
\begin{itemize}


%%--------------------------------------

\item \ID{N\_VGetVector\_Trilinos}

  This C++ function takes an \id{N\_Vector} as the argument and returns a reference
  counting pointer to the underlying Tpetra vector. This is a standalone function
  defined in the global namespace.

\begin{verbatim}
Teuchos::RCP<vector_type> N_VGetVector_Trilinos(N_Vector v);
\end{verbatim}


%%--------------------------------------

\item \ID{N\_VMake\_Trilinos}

  This C++ function creates and allocates memory for an {\nvectrilinos}
  wrapper around a user-provided Tpetra vector. This is a standalone function
  defined in the global namespace.

\begin{verbatim}
N_Vector N_VMake_Trilinos(Teuchos::RCP<vector_type> v);
\end{verbatim}


\end{itemize}
%%
%%------------------------------------
%%
\paragraph{\bf Notes}

\begin{itemize}

\item

  The template parameter \id{vector\_type} should be set as:\\
  \verb|  typedef Sundials::TpetraVectorInterface::vector_type vector_type|\\
   This will ensure that data types used in Tpetra vector match those in {\sundials}.

\item
  When there is a need to access components of an \id{N\_Vector\_Trilinos}, \id{v},
  it is recommeded to extract the {\trilinos} vector object via
  \id{x\_vec = N\_VGetVector\_Trilinos(v)} and then access components using
  the appropriate {\trilinos} functions.

\item
  The functions \id{N\_VDestroy\_Trilinos} and \id{N\_VDestroyVectorArray\_Trilinos}
  only delete the \id{N\_Vector} wrapper. The underlying Tpetra vector object will exist for as long as
  there is at least one reference to it.

\end{itemize}
