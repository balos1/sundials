%% This is a shared SUNDIALS TEX file with a description of the
%% superludist sunlinsol implementation
%%
\section{The SUNLinearSolver\_SuperLUDIST implementation}\label{ss:sunlinsol_sludist}

The {\superludist} implementation of the {\sunlinsol} module provided with
{\sundials},\\
\noindent{\sunlinsolsludist}, is designed to be used with the
corresponding {\sunmatslunrloc} matrix type, and one of the serial, threaded
or parallel {\nvector} implementations ({\nvecs}, {\nvecopenmp}, {\nvecpthreads},
{\nvecp}, or {\nvecph}).

The header file to include when using this module
is \id{sunlinsol/sunlinsol\_superludist.h}. The installed module
library to link to is
\id{libsundials\_sunlinsolsuperludist.\textit{lib}}
where \id{\em.lib} is typically \id{.so} for shared libraries and
\id{.a} for static libraries.


% --------------------------------------------------------------------
\subsection{SUNLinearSolver\_SuperLUDIST description}\label{ss:sunlinsol_sludist_description}

The {\sunlinsolsludist} module is a {\sunlinsol} adapter for the
{\superludist} sparse matrix factorization and solver library written by
X. Sherry Li \cite{SuperLUDIST_site,GDL:07,LD:03,SLUUG:99}.
The package uses a SPMD parallel programming model and multithreading
to enhance efficiency in distributed-memory parallel environments with
multicore nodes and possibly GPU accelerators. It uses {\mpi} for communication,
{\openmp} for threading, and {\cuda} for GPU support. In order to use the
{\sunlinsolsludist} interface to {\superludist}, it is assumed that {\superludist}
has been installed on the system prior to installation of {\sundials}, and
that {\sundials} has been configured appropriately to link with {\superludist}
(see Appendix \ref{c:install} for details). Additionally, the adapter only
supports double-precision calculations, and therefore cannot be compiled if {\sundials}
is configured to use single or extended precision. Moreover, since the {\superludist}
library may be installed to support either 32-bit or 64-bit integers,
it is assumed that the {\superludist} library is installed using the same
integer size as {\sundials}.

The {\superludist} library provides many options to control how a linear
system will be solved. These options may be set by a user on an instance
of the \id{superlu\_dist\_options\_t} struct, and then it may be provided
as an argument to the {\sunlinsolsludist} constructor. The {\sunlinsolsludist}
module will respect all options set except for \id{Fact} -- this option is
necessarily modified by the {\sunlinsolsludist} module in the setup and solve routines.

Since the linear systems that arise within the context of {\sundials}
calculations will typically have identical sparsity patterns, the
{\sunlinsolsludist} module is constructed to perform the
following operations:
\begin{itemize}
\item The first time that the ``setup'' routine is called, it
  sets the {\superludist} option \id{Fact} to \id{DOFACT} so that a subsequent
  call to the ``solve'' routine will perform a symbolic factorization,
  followed by an initial numerical factorization before continuing
  to solve the system.
\item On subsequent calls to the ``setup'' routine, it sets the
  {\superludist} option \id{Fact} to \id{SamePattern} so that
  a subsequent call to ``solve'' will perform factorization assuming
  the same sparsity pattern as prior, i.e. it will reuse the column
  permutation vector.
\item If ``setup'' is called prior to the ``solve'' routine, then the ``solve''
  routine will perform a symbolic factorization, followed by an initial
  numerical factorization before continuing to the sparse triangular
  solves, and, potentially, iterative refinement. If ``setup'' is not
  called prior, ``solve'' will skip to the triangular solve step. We
  note that in this solve {\superludist} operates on the native data arrays
  for the right-hand side and solution vectors, without requiring costly data copies.
\end{itemize}


{\warn} Starting with SuperLU\_DIST version 6.3.0, some structures were renamed
to have a prefix for the floating point type. The double precision API functions
have the prefix 'd'. To maintain backwards compatibility with the unprefixed
types, SUNDIALS provides macros to these SuperLU\_DIST types with an 'x' prefix
that expand to the correct prefix. E.g., the SUNDIALS macro \id{xLUstruct\_t}
expands to \id{dLUstruct\_t} or \id{LUstruct\_t} based on the SuperLU\_DIST
version.


\subsection{SUNLinearSolver\_SuperLUDIST functions}\label{ss:sunlinsol_sludist_functions}

The {\sunlinsolsludist} module defines implementations of all
``direct'' linear solver operations listed in Sections
\ref{ss:sunlinsol_CoreFn}-\ref{ss:sunlinsol_GetFn}:
\begin{itemize}
\item \id{SUNLinSolGetType\_SuperLUDIST}
\item \id{SUNLinSolInitialize\_SuperLUDIST} -- this sets the
  \id{first\_factorize} flag to 1 and resets the internal {\superludist}
  statistics variables.
\item \id{SUNLinSolSetup\_SuperLUDIST} -- this sets the appropriate
  {\superludist} options so that a subsequent solve will perform a
  symbolic and numerical factorization before proceeding with the
  triangular solves
\item \id{SUNLinSolSolve\_SuperLUDIST} -- this calls the {\superludist}
  solve routine to perform factorization (if the setup routine
  was called prior) and then use the $LU$ factors to solve the
  linear system.
\item \id{SUNLinSolLastFlag\_SuperLUDIST}
\item \id{SUNLinSolSpace\_SuperLUDIST} -- this only returns information for
  the storage within the solver \emph{interface}, i.e.~storage for the
  integers \id{last\_flag} and \id{first\_factorize}.  For additional
  space requirements, see the {\superludist} documentation.
\item \id{SUNLinSolFree\_SuperLUDIST}
\end{itemize}

In addition, the module {\sunlinsolsludist} provides the following user-callable routines:
%%
% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST}
{
  LS = SUNLinSol\_SuperLUDIST(y, A, grid, lu, scaleperm, solve, stat, options);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST} creates and allocates memory for a
  {\sunlinsolsludist} object.
}
{
  \begin{args}[options]
  \item[y] (\id{N\_Vector})
    a template for cloning vectors needed within the solver
  \item[A] (\id{SUNMatrix})
    a {\sunmatslunrloc} matrix template for cloning matrices needed
    within the solver
  \item[grid] (\id{gridinfo\_t*})
  \item[lu] (\id{LUstruct\_t*})
  \item[scaleperm] (\id{ScalePermstruct\_t*})
  \item[solve] (\id{SOLVEstruct\_t*})
  \item[stat] (\id{SuperLUStat\_t*})
  \item[options] (\id{superlu\_dist\_options\_t*})
  \end{args}
}
{
  This returns a \id{SUNLinearSolver} object.  If either \id{A} or
  \id{y} are incompatible then this routine will return \id{NULL}.
}
{
  This routine analyzes the input matrix and vector to determine the
  linear system size and to assess compatibility with the {\superludist}
  library.

  This routine will perform consistency checks to ensure that it is
  called with consistent {\nvector} and {\sunmatrix} implementations.
  These are currently limited to the {\sunmatslunrloc} matrix type
  and the {\nvecs}, {\nvecp}, {\nvecph}, {\nvecopenmp}, and {\nvecpthreads}
  vector types. As additional compatible matrix and vector implementations
  are added to {\sundials}, these will be included within this compatibility
  check.

  The \id{grid}, \id{lu}, \id{scaleperm}, \id{solve}, and \id{options} arguments
  are not checked and are passed directly to {\superludist} routines.

  Some struct members of the \id{options} argument are modified internally
  by the {\sunlinsolsludist} solver. Specifically the member \id{Fact},
  is modified in the setup and solve routines.
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetBerr}
{
  realtype berr = SUNLinSol\_SuperLUDIST\_GetBerr(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetBerr} returns the componentwise
  relative backward error of the computed solution.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{realtype}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetGridinfo}
{
  gridinfo\_t *grid = SUNLinSol\_SuperLUDIST\_GetGridinfo(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetGridinfo} returns the
  {\superludist} structure that contains the 2D process grid.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{gridinfo\_t*}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetLUstruct}
{
  LUstruct\_t *lu = SUNLinSol\_SuperLUDIST\_GetLUstruct(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetLUstruct} returns the
  {\superludist} structure that contains the distributed $L$ and $U$ factors.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{LUstruct\_t*}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetSuperLUOptions}
{
  superlu\_dist\_options\_t *opts = SUNLinSol\_SuperLUDIST\_GetSuperLUOptions(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetSuperLUOptions} returns the
  {\superludist} structure that contains the options which control how
  the linear system is factorized and solved.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{superlu\_dist\_options\_t*}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetScalePermstruct}
{
  ScalePermstruct\_t *sp = SUNLinSol\_SuperLUDIST\_GetScalePermstruct(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetScalePermstruct} returns the
  {\superludist} structure that contains the vectors that describe the
  transformations done to the matrix, $A$.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{ScalePermstruct\_t*}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetSOLVEstruct}
{
  SOLVEstruct\_t *solve = SUNLinSol\_SuperLUDIST\_GetSOLVEstruct(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetSOLVEstruct} returns the
  {\superludist} structure that contains information for communication
  during the solution phase.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{SOLVEstruct\_t*}
}
{
}

% --------------------------------------------------------------------
\ucfunction{SUNLinSol\_SuperLUDIST\_GetSuperLUStat}
{
  SuperLUStat\_t *stat = SUNLinSol\_SuperLUDIST\_GetSuperLUStat(LS);
}
{
  The function \ID{SUNLinSol\_SuperLUDIST\_GetSuperLUStat} returns the
  {\superludist} structure that stores information about runtime and
  flop count.
}
{
  \begin{args}[LS]
  \item[LS] (\id{SUNLinearSolver})
    the {\sunlinsolsludist} object
  \end{args}
}
{
  \id{SuperLUStat\_t*}
}
{
}


% --------------------------------------------------------------------
\subsection{SUNLinearSolver\_SuperLUDIST content}\label{ss:sunlinsol_sludist_content}

The {\sunlinsolsludist} module defines the {\em
content} field of a \id{SUNLinearSolver} to be the following structure:
%%
\begin{verbatim}
struct _SUNLinearSolverContent_SuperLUDIST {
  booleantype             first_factorize;
  int                     last_flag;
  realtype                berr;
  gridinfo_t              *grid;
  xLUstruct_t             *lu;
  superlu_dist_options_t  *options;
  xScalePermstruct_t      *scaleperm;
  xSOLVEstruct_t          *solve;
  SuperLUStat_t           *stat;
  sunindextype            N;
};
\end{verbatim}
%%
These entries of the \emph{content} field contain the following
information:
\begin{description}
  \item[first\_factorize] - flag indicating whether the factorization
    has ever been performed,
  \item[last\_flag] - last error return flag from calls to internal routines,
  \item[berr] - the componentwise relative backward error of the computed solution,
  \item[grid] - pointer to the {\superludist} structure that stores the 2D process grid,
  \item[lu] - pointer to the {\superludist} structure that stores the distributed $L$
    and $U$ factors,
  \item[options] - pointer to {\superludist} options structure,
  \item[scaleperm] - pointer to the {\superludist} structure that stores vectors describing
    the transformations done to the matrix, $A$,
  \item[solve] - pointer to the {\superludist} solve structure,
  \item[stat] - pointer to the {\superludist} structure that stores information about runtime
    and flop count,
  \item[N] - the number of equations in the system
\end{description}
