%%
\section{The SUNMATRIX\_MAGMADENSE implementation}\label{ss:sunmat_magmadense}

The \id{SUNMATRIX\_MAGMADENSE} implementation of the {\sundials} \id{SUNMatrix}
API interfaces to the MAGMA (\href{https://icl.utk.edu/magma/}) linear algebra
library, and can target NVIDIA's CUDA programming model or AMD's HIP programming
model \cite{magma_ref}. All data stored by this matrix implementation resides on
the GPU at all times. The implementation currently supports a standard LAPACK
column-major storage format as well as a low-storage format for block-diagonal
matrices
\begin{equation*}
  \mathbf{A} =
  \begin{bmatrix}
    \mathbf{A_0} & 0 & \cdots & 0\\
    0 & \mathbf{A_1} & \cdots & 0\\
    \vdots & \vdots & \ddots & \vdots\\
    0 & 0 & \cdots & \mathbf{A_{n-1}}\\
  \end{bmatrix}.
\end{equation*}
This matrix implementation is best paired with the \id{SUNLINEARSOLVER\_MAGMADENSE}
\id{SUNLinearSolver}.

The header file to include when using this module is
\id{sunmatrix/sunmatrix\_magmadense.h}. The installed library to link to is
\id{libsundials\_sunmatrixmagmadense.\textit{lib}} where \id{\em.lib} is typically \id{.so}
for shared libraries and \id{.a} for static libraries.
\newline
\newline
{\warn}The \id{SUNMATRIX\_MAGMADENSE} module is experimental and subject to change.

% ====================================================================
\subsection{SUNMATRIX\_MAGMADENSE functions}
\label{ss:sunmat_magmadense_functions}
% ====================================================================

The \id{SUNMATRIX\_MAGMADENSE} module defines GPU-enabled implementations
of all matrix operations listed in Section \ref{ss:sunmatrix_functions}.

\begin{enumerate}
  \item \id{SUNMatGetID\_MagmaDense} -- returns \id{SUNMATRIX\_MAGMADENSE}
  \item \id{SUNMatClone\_MagmaDense}
  \item \id{SUNMatDestroy\_MagmaDense}
  \item \id{SUNMatZero\_MagmaDense}
  \item \id{SUNMatCopy\_MagmaDense}
  \item \id{SUNMatScaleAdd\_MagmaDense}
  \item \id{SUNMatScaleAddI\_MagmaDense}
  \item \id{SUNMatMatvecSetup\_MagmaDense}
  \item \id{SUNMatMatvec\_MagmaDense}
  \item \id{SUNMatSpace\_MagmaDense}
\end{enumerate}


In addition, the SUNMATRIX\_MAGMADENSE module defines the following implementation specific
functions:

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense}
{
  A = SUNMatrix\_MagmaDense(M, N, memtype, memhelper, queue)
}
{
  This constructor function creates and allocates memory for an $M \times N$
  \id{SUNMATRIX\_MAGMADENSE} \id{SUNMatrix}.
}
{
  \begin{args}[memhelper]
  \item[M] (\id{sunindextype}) the number of matrix rows
  \item[N] (\id{sunindextype}) the number of matrix columns
  \item[memtype] (\id{SUNMemoryType}) the type of memory to use for the matrix data; can be \id{SUNMEMTYPE\_UVM} or \id{SUNMEMTYPE\_DEVICE}.
  \item[memhelper] (\id{SUNMemoryHelper}) the memory helper used for allocating data
  \item[queue] a \id{cudaStream\_t} when using CUDA or a \id{hipStream\_t} when using HIP
  \end{args}
}
{
  A \id{SUNMatrix} object if successful else \id{NULL}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDenseBlock}
{
  A = SUNMatrix\_MagmaDenseBlock(nblocks, M\_block, N\_block, memtype, memhelper, queue)
}
{
  This constructor function creates and allocates memory for a \id{SUNMATRIX\_MAGMADENSE}
  \id{SUNMatrix} that is block diagonal with \id{nblocks} blocks of size
  $M \times N$.
}
{
  \begin{args}[memhelper]
  \item[nblocks] (\id{sunindextype}) the number of matrix blocks
  \item[M\_block] (\id{sunindextype}) the number of matrix rows in each block
  \item[N\_block] (\id{sunindextype}) the number of matrix columns in each block
  \item[memtype] (\id{SUNMemoryType}) the type of memory to use for the matrix data; can be \id{SUNMEMTYPE\_UVM} or \id{SUNMEMTYPE\_DEVICE}.
  \item[memhelper] (\id{SUNMemoryHelper}) the memory helper used for allocating data
  \item[queue] a \id{cudaStream\_t} when using CUDA or a \id{hipStream\_t} when using HIP
  \end{args}
}
{
  A \id{SUNMatrix} object if successful else \id{NULL}.
}
{
  The block diagonal format currently supports square matrices only.
}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_Rows}
{
  M = SUNMatrix\_MagmaDense\_Rows(A)
}
{
  This function returns the rows dimension for the $M \times N$ \id{SUNMatrix}.
  For block diagonal matrices, this is computed as $M_{\text{block}} \times \text{nblocks}$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of rows in the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_Columns}
{
  N = SUNMatrix\_MagmaDense\_Columns(A)
}
{
  This function returns the columns dimension for the $M \times N$ \id{SUNMatrix}.
  For block diagonal matrices, this is computed as $N_{\text{block}} \times \text{nblocks}$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of columns in the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_BlockRows}
{
  M = SUNMatrix\_MagmaDense\_BlockRows(A)
}
{
  This function returns the number of rows in a block of the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of rows in a block of the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_BlockColumns}
{
  N = SUNMatrix\_MagmaDense\_BlockColumns(A)
}
{
  This function returns the number of columns in a block of the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of columns in a block of the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_LData}
{
  ldata = SUNMatrix\_MagmaDense\_LData(A)
}
{
  This function returns the length of the data array for the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The length of the data array for the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_NumBlocks}
{
  nblocks = SUNMatrix\_MagmaDense\_NumBlocks(A)
}
{
  This function returns the number of blocks in the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of matrix blocks.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_Data}
{
  data = SUNMatrix\_MagmaDense\_Data(A)
}
{
  This function returns the \id{SUNMatrix} data array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  An array of pointers to the data arrays for each block in the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_BlockData}
{
  data = SUNMatrix\_MagmaDense\_BlockData(A)
}
{
  This function returns an array of pointers that point to
  the start of the data array for each block.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  An array of pointers to the data arrays for each block in the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_Block}
{
  data = SUNMatrix\_MagmaDense\_Block(A, k)
}
{
  This function returns a pointer to the data for block $k$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for block $k$ in the \id{SUNMatrix}.
}
{
  No bounds-checking is performed, $k$ should be stricly less than
  $\text{nblocks}$.
}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_Column}
{
  data = SUNMatrix\_MagmaDense\_Column(A, j)
}
{
  This function returns a pointer to the data for column $j$ of the matrix.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for column $j$ of the \id{SUNMatrix}.
}
{
  No bounds-checking is performed, $j$ should be stricly less than
  $\text{nblocks} * N_{\text{block}}$.
}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_BlockColumn}
{
  data = SUNMatrix\_MagmaDense\_Column(A, k, j)
}
{
  This function returns a pointer to the data for column $j$ of block $k$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for column $j$ of block $k$ in the
  \id{SUNMatrix}.
}
{
  No bounds-checking is performed.
}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_CopyToDevice}
{
  retval = SUNMatrix\_MagmaDense\_CopyToDevice(A, h\_data)
}
{
  This functions copies the matrix data to the GPU device from the provided
  host array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \item[h\_data] (\id{realtype*})
  \end{args}
}
{
  \id{SUNMAT\_SUCCESS} if the copy operation was successful, or a nonzero error
  code otherwise
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_MagmaDense\_CopyFromDevice}
{
  retval = SUNMatrix\_MagmaDense\_CopyFromDevice(A, h\_data)
}
{
  This functions copies the matrix data from the GPU device to the provided
  host array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \item[h\_data] (\id{realtype*})
  \end{args}
}
{
  \id{SUNMAT\_SUCCESS} if the copy operation was successful, or a nonzero error
  code otherwise
}
{}

% ====================================================================
\subsection{SUNMATRIX\_MAGMADENSE Usage Notes}
\label{ss:sunmat_magmadense_notes}
% ====================================================================

% The \id{SUNMATRIX\_MAGMADENSE} module only supports 32-bit indexing,
% thus {\sundials} must be built for 32-bit indexing to use this module.

{\warn} When using the \id{SUNMATRIX\_MAGMADENSE} module with a {\sundials}
package (e.g. {\cvode}), the stream given to matrix should be the same
stream used for the {\nvector} object that is provided to the package,
and the {\nvector} object given to the \id{SUNMatvec} operation. If different
streams are utilized, synchronization issues may occur.
