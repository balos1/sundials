%%
\section{The SUNMATRIX\_ONEMKLDENSE implementation}
\label{ss:sunmat_onemkldense}

The \id{SUNMATRIX\_ONEMKLDENSE} implementation of the SUNMatrix class is
intended for interfacing with direct linear solvers from the
\href{https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/onemkl.html}{Intel oneAPI Math Kernel Library (oneMKL)}
using the SYCL (DPC++) programming model. The implementation currently supports
a standard LAPACK column-major storage format as well as a low-storage format
for block-diagonal matrices

\begin{equation*}
  \mathbf{A} =
  \begin{bmatrix}
    \mathbf{A_0} & 0            & \cdots & 0 \\
    0            & \mathbf{A_2} & \cdots & 0 \\
    \vdots       & \vdots       & \ddots & \vdots \\
    0            & 0            & \cdots & \mathbf{A_{n-1}}
  \end{bmatrix}
\end{equation*}
This matrix implementation is best paired with the \id{SUNLINEARSOLVER\_ONEMKLDENSE}
\id{SUNLinearSolver}.

The header file to include when using this class is
\id{sunmatrix/sunmatrix\_onemkldense.h}. The installed library to link to is
\id{libsundials\_sunmatrixonekkldense.\textit{lib}} where \id{\em.lib} is
typically \id{.so} for shared libraries and \id{.a} for static libraries.
\newline
\newline
{\warn}The \id{SUNMATRIX\_ONEMKLDENSE} class is experimental and subject to
change.

% ====================================================================
\subsection{SUNMATRIX\_ONEMKLDENSE functions}
\label{ss:sunmat_onemkldense_functions}
% ====================================================================

The \id{SUNMATRIX\_ONEMKLDENSE} class defines implementations of the following
matrix operations listed in Section \ref{ss:sunmatrix_functions}.

\begin{enumerate}
  \item \id{SUNMatGetID\_OneMklDense} -- returns \id{SUNMATRIX\_ONEMKLDENSE}
  \item \id{SUNMatClone\_OneMklDense}
  \item \id{SUNMatDestroy\_OneMklDense}
  \item \id{SUNMatZero\_OneMklDense}
  \item \id{SUNMatCopy\_OneMklDense}
  \item \id{SUNMatScaleAdd\_OneMklDense}
  \item \id{SUNMatScaleAddI\_OneMklDense}
  \item \id{SUNMatMatvec\_OneMklDense}
  \item \id{SUNMatSpace\_OneMklDense}
\end{enumerate}


In addition, the \id{SUNMATRIX\_ONEMKLDENSE} class class defines the following
implementation specific functions.

\subsubsection*{Constructors}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense}
{
  A = SUNMatrix\_OneMklDense(M, N, memtype, memhelper, queue)
}
{
  This constructor function creates and allocates memory for an $M \times N$
  \id{SUNMATRIX\_ONEMKLDENSE} \id{SUNMatrix}.
}
{
  \begin{args}[memhelper]
  \item[M] (\id{sunindextype}) the number of matrix rows
  \item[N] (\id{sunindextype}) the number of matrix columns
  \item[memtype] (\id{SUNMemoryType}) the type of memory to use for the matrix data; can be \id{SUNMEMTYPE\_UVM} or \id{SUNMEMTYPE\_DEVICE}.
  \item[memhelper] (\id{SUNMemoryHelper}) the memory helper used for allocating data
  \item[queue] (\id{sycl::queue*}) the SYCL queue to which operation will be submitted
  \end{args}
}
{
  A \id{SUNMatrix} object if successful else \id{NULL}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDenseBlock}
{
  A = SUNMatrix\_OneMklDenseBlock(nblocks, M\_block, N\_block, memtype, memhelper, queue)
}
{
  This constructor function creates and allocates memory for a \id{SUNMATRIX\_ONEMKLDENSE}
  \id{SUNMatrix} that is block diagonal with \id{nblocks} blocks of size
  $M_{block} \times N_{block}$.
}
{
  \begin{args}[memhelper]
  \item[nblocks] (\id{sunindextype}) the number of matrix blocks
  \item[M\_block] (\id{sunindextype}) the number of matrix rows in each block
  \item[N\_block] (\id{sunindextype}) the number of matrix columns in each block
  \item[memtype] (\id{SUNMemoryType}) the type of memory to use for the matrix data; can be \id{SUNMEMTYPE\_UVM} or \id{SUNMEMTYPE\_DEVICE}.
  \item[memhelper] (\id{SUNMemoryHelper}) the memory helper used for allocating data
  \item[queue] (\id{sycl::queue*}) the SYCL queue to which operation will be submitted
  \end{args}
}
{
  A \id{SUNMatrix} object if successful else \id{NULL}.
}
{
  The block diagonal format currently supports square matrices only.
}


\subsubsection*{Access Matrix Dimensions}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_Rows}
{
  M = SUNMatrix\_OneMklDense\_Rows(A)
}
{
  This function returns the rows dimension for the $M \times N$ \id{SUNMatrix}.
  For block diagonal matrices, this is computed as $M_{\text{block}} \times \text{nblocks}$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of rows in the \id{SUNMatrix}.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_Columns}
{
  N = SUNMatrix\_OneMklDense\_Columns(A)
}
{
  This function returns the columns dimension for the $M \times N$ \id{SUNMatrix}.
  For block diagonal matrices, this is computed as $N_{\text{block}} \times \text{nblocks}$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of columns in the \id{SUNMatrix}.
}
{}


\subsubsection*{Access Matrix Block Dimensions}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_NumBlocks}
{
  nblocks = SUNMatrix\_OneMklDense\_NumBlocks(A)
}
{
  This function returns the number of blocks in the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of matrix blocks.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_BlockRows}
{
  M = SUNMatrix\_OneMklDense\_BlockRows(A)
}
{
  This function returns the number of rows in a block of the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of rows in a block of the \id{SUNMatrix}.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_BlockColumns}
{
  N = SUNMatrix\_OneMklDense\_BlockColumns(A)
}
{
  This function returns the number of columns in a block of the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The number of columns in a block of the \id{SUNMatrix}.
}
{}


\subsubsection*{Access Matrix Data}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_LData}
{
  ldata = SUNMatrix\_OneMklDense\_LData(A)
}
{
  This function returns the length of the data array for the \id{SUNMatrix}.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The length of the data array for the \id{SUNMatrix}.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_Data}
{
  data = SUNMatrix\_OneMklDense\_Data(A)
}
{
  This function returns the \id{SUNMatrix} data array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  An array of pointers to the data arrays for each block in the \id{SUNMatrix}.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_Column}
{
  data = SUNMatrix\_OneMklDense\_Column(A, j)
}
{
  This function returns a pointer to the data for column $j$ of the matrix.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for column $j$ of the \id{SUNMatrix}.
}
{
  No bounds-checking is performed, $j$ should be stricly less than
  $\text{nblocks} * N_{\text{block}}$.
}


\subsubsection*{Access Matrix Data}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_BlockLData}
{
  ldata = SUNMatrix\_OneMklDense\_BlockLData(A)
}
{
  This function returns the length of the data array for the \id{SUNMatrix} for
  each block of the \id{SUNMatrix} object.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  The length of the data array for each block of the \id{SUNMatrix}.
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_BlockData}
{
  data = SUNMatrix\_OneMklDense\_BlockData(A)
}
{
  This function returns an array of pointers that point to
  the start of the data array for each block.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  An array of pointers to the data arrays for each block in the \id{SUNMatrix}.
}
{}

%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_Block}
{
  data = SUNMatrix\_OneMklDense\_Block(A, k)
}
{
  This function returns a pointer to the data for block $k$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for block $k$ in the \id{SUNMatrix}.
}
{
  No bounds-checking is performed, $k$ should be stricly less than
  $\text{nblocks}$.
}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_BlockColumn}
{
  data = SUNMatrix\_OneMklDense\_Column(A, k, j)
}
{
  This function returns a pointer to the data for column $j$ of block $k$.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \end{args}
}
{
  A pointer to the start of the data array for column $j$ of block $k$ in the
  \id{SUNMatrix}.
}
{
  No bounds-checking is performed.
}


\subsubsection*{Copy Data}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_CopyToDevice}
{
  retval = SUNMatrix\_OneMklDense\_CopyToDevice(A, h\_data)
}
{
  This functions copies the matrix data to the GPU device from the provided
  host array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \item[h\_data] (\id{realtype*})
  \end{args}
}
{
  \id{SUNMAT\_SUCCESS} if the copy operation was successful, or a nonzero error
  code otherwise
}
{}


%%--------------------------------------
%%
\ucfunction{SUNMatrix\_OneMklDense\_CopyFromDevice}
{
  retval = SUNMatrix\_OneMklDense\_CopyFromDevice(A, h\_data)
}
{
  This functions copies the matrix data from the GPU device to the provided
  host array.
}
{
  \begin{args}
  \item[A] (\id{SUNMatrix})
  \item[h\_data] (\id{realtype*})
  \end{args}
}
{
  \id{SUNMAT\_SUCCESS} if the copy operation was successful, or a nonzero error
  code otherwise
}
{}

% ====================================================================
\subsection{SUNMATRIX\_ONEMKLDENSE Usage Notes}
\label{ss:sunmat_OneMkldense_notes}
% ====================================================================

The \id{SUNMATRIX\_ONEMKLDENSE} class only supports 64-bit indexing,
thus {\sundials} must be built for 64-bit indexing to use this class.

{\warn} When using the \id{SUNMATRIX\_ONEMKLDENSE} class with a {\sundials}
package (e.g. {\cvode}), the stream given to matrix should be the same
stream used for the {\nvector} object that is provided to the package,
and the {\nvector} object given to the \id{SUNMatvec} operation. If different
streams are utilized, synchronization issues may occur.
