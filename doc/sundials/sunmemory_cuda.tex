% ===================================================================
\section{The \id{SUNMemoryHelper\_Cuda} implementation}\label{s:sunmemory_cuda}
% ====================================================================

The \id{SUNMemoryHelper\_Cuda} module is an implementation of the \id{SUNMemoryHelper} API
that interfaces to the NVIDIA CUDA \cite{cuda_site} library.  The implementation defines
the constructor

\ucfunction{SUNMemoryHelper\_Cuda}
{
  helper = SUNMemoryHelper\_Cuda();
}
{
  Allocates and returns a \id{SUNMemoryHelper} object for handling CUDA memory.
}
{}
{
  A \id{SUNMemoryHelper} object if successful, or \id{NULL} if not.
}
{}


%
%
\subsection{\id{SUNMemoryHelper} API functions}\label{ss:sunmemcuda_functions}

The implementation provides the following operations defined by the \id{SUNMemoryHelper} API:

\ucfunction{SUNMemoryHelper\_Alloc\_Cuda}
{
  retval = SUNMemoryHelper\_Alloc\_Cuda(helper, *memptr, mem\_size, mem\_type);
}
{
  Allocates a \id{SUNMemory} object whose \id{ptr} field is allocated for
  \id{mem\_size} bytes and is of type \id{mem\_type}. The new object will
  have ownership of \id{ptr} and will be deallocated when
  \id{SUNMemoryHelper\_Dealloc} is called.

  The \id{SUNMemoryType} supported are
  \begin{itemize}
    \item \id{SUNMEMTYPE\_HOST} -- memory is allocated with a call to \id{malloc}
    \item \id{SUNMEMTYPE\_PINNED} -- memory is allocated with a call to \id{cudaMallocHost}
    \item \id{SUNMEMTYPE\_DEVICE} -- memory is allocated with a call to \id{cudaMalloc}
    \item \id{SUNMEMTYPE\_UVM} -- memory is allocated with a call to \id{cudaMallocManaged}
  \end{itemize}
}
{
  \begin{args}[mem\_type]
  \item[helper] (\id{SUNMemoryHelper}) the \id{SUNMemoryHelper} object
  \item[memptr] (\id{SUNMemory*}) pointer to the allocated \id{SUNMemory}
  \item[mem\_size] (\id{size\_t}) the size in bytes of the \id{ptr}
  \item[mem\_type] (\id{SUNMemoryType}) the \id{SUNMemoryType} of the \id{ptr}
  \end{args}
}
{
  An \id{int} flag indicating success (zero) or failure (non-zero).
}
{}

\ucfunction{SUNMemoryHelper\_Dealloc\_Cuda}
{
  retval = SUNMemoryHelper\_Dealloc\_Cuda(helper, mem);
}
{
  Deallocates the \id{mem->ptr} field if it is owned by \id{mem}, and then
  deallocates the \id{mem} object.
}
{
  \begin{args}[helper]
  \item[helper] (\id{SUNMemoryHelper}) the \id{SUNMemoryHelper} object
  \item[mem] (\id{SUNMemory}) the \id{SUNMemory} object
  \end{args}
}
{
  An \id{int} flag indicating success (zero) or failure (non-zero).
}
{}

\ucfunction{SUNMemoryHelper\_Copy\_Cuda}
{
  retval = SUNMemoryHelper\_Copy\_Cuda(helper, dst, src, mem\_size);
}
{
  Synchronously copies \id{mem\_size} bytes from the the source memory to the
  destination memory.  The copy can be across memory spaces, e.g. host to
  device, or within a memory space, e.g. host to host. The \id{helper}
  object will use the memory types of \id{dst} and \id{src} to determine
  the appropriate transfer type necessary.
}
{
  This operation uses \id{cudaMemcpy} underneath.
}
{
  \begin{args}[mem\_size]
  \item[helper] (\id{SUNMemoryHelper}) the \id{SUNMemoryHelper} object
  \item[dst] (\id{SUNMemory}) the destination memory to copy to
  \item[src] (\id{SUNMemory}) the source memory to copy from
  \item[mem\_size] (\id{size\_t}) the number of bytes to copy
  \end{args}
}
{
  An \id{int} flag indicating success (zero) or failure (non-zero).
}
{}

\ucfunction{SUNMemoryHelper\_CopyAsync\_Cuda}
{
  retval = SUNMemoryHelper\_CopyAsync\_Cuda(helper, dst, src, mem\_size, ctx);
}
{
  Asynchronously copies \id{mem\_size} bytes from the the source memory to the
  destination memory.  The copy can be across memory spaces, e.g. host to
  device, or within a memory space, e.g. host to host. The \id{helper}
  object will use the memory types of \id{dst} and \id{src} to determine
  the appropriate transfer type necessary.
}
{
  This operation uses \id{cudaMemcpyAsync} underneath.
}
{
  \begin{args}[mem\_size]
  \item[helper] (\id{SUNMemoryHelper}) the \id{SUNMemoryHelper} object
  \item[dst] (\id{SUNMemory}) the destination memory to copy to
  \item[src] (\id{SUNMemory}) the source memory to copy from
  \item[mem\_size] (\id{size\_t}) the number of bytes to copy
  \item[ctx] (\id{void *}) the \id{cudaStream\_t} handle for the stream that the copy
  will be performed on
  \end{args}
}
{
  An \id{int} flag indicating success (zero) or failure (non-zero).
}
{}
